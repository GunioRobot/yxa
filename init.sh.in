#!/bin/sh
#
# Script created from Yxa init.sh.in
#

PROGRAMNAME="@PROGRAMNAME@"
CONFIGDIR="@CONFIGDIR@"
SSLCERTDIR="@SSLCERTDIR@"
MNESIADIR="@MNESIADIR@"
beamdir="@beamdir@"
erl="@erl@"
DETACH="-detached"

MYNAME=`basename $0`

# Calculate Erlang arguments
CONFIGPATH="$CONFIGDIR/$PROGRAMNAME"

if [ "x$SSLCERTDIR" = "x" ]; then
    SSLCERTFILE="$CONFIGDIR/ssl/cert.comb"
else
    SSLCERTFILE="$SSLCERTDIR/cert.comb"
fi

if [ -f ${SSLCERTFILE} ] ; then
    ssloptions="-proto_dist inet_ssl " \
	"-ssl_dist_opt client_certfile $SSLCERTFILE" \
	" -ssl_dist_opt server_certfile $SSLCERTFILE -ssl_dist_opt verify 2"
else
    echo "WARNING: starting without SSL - " \
	"missing certificate file ${SSLCERTFILE}"
fi

if [ "x$MNESIADIR" = "x" ]; then
    MNESIAPARAMETERS=""
else
    MNESIAPARAMETERS="-mnesia dir '"$MNESIADIR"'"
fi

if [ "x$1" = "x-d" ]; then
    DETACH=""
fi

if [ "x$MYNAME" = "xbootstrap.sh" ]; then
    if [ "x$ADMINPW" = "x" ]; then
	echo "You are not following the instructions in README!"
	echo ""
	echo "You need to set the environment variable ADMINPW"
	echo "before executing $0. Like this :"
	echo ""
	echo "  $ ADMINPW=foo $0"
	echo ""
	exit 1
    fi

	# yes, the name should be incomingproxy when bootstrapping
    ${erl} -pz ${beamdir} -name incomingproxy -noshell $MNESIAPARAMETERS \
	-run bootstrap start "$ADMINPW" -run init stop
else
    if [ ! -r "${CONFIGPATH}.config" ]; then
	echo "$0: Configuration file ${CONFIGPATH}.config not found or not readable"
	exit 1
    fi

    ${erl} -boot $PROGRAMNAME -pz ${beamdir} \
	-name $PROGRAMNAME -config $CONFIGPATH \
	$ssloptions \
	$MNESIAPARAMETERS $DETACH
fi
